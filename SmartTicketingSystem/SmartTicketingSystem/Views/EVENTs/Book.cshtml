@model List<SmartTicketingSystem.Models.ViewModels.TicketTypeVM>
@{
    ViewData["Title"] = "Book Tickets - " + ViewBag.Event.title;
    var ev = ViewBag.Event as SmartTicketingSystem.Models.EVENT;
    var eventId = ViewBag.EventId;
    var availablePromos = ViewBag.EventPromos as List<SmartTicketingSystem.Models.PROMO_CODE> ?? new List<SmartTicketingSystem.Models.PROMO_CODE>();
}

<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="EVENTs" asp-action="Index">Events</a></li>
            <li class="breadcrumb-item"><a asp-controller="EVENTs" asp-action="Details" asp-route-id="@eventId">@ev?.title</a></li>
            <li class="breadcrumb-item active" aria-current="page">Book Tickets</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Booking Form -->
        <div class="col-lg-8">
            <div class="card booking-card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>Book Tickets for @ev?.title</h4>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Book" method="post" id="bookingForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="eventId" value="@eventId" />

                        <!-- Event Summary -->
                        <div class="event-summary bg-light p-3 rounded mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><i class="fas fa-calendar-alt text-primary me-2"></i>@ev?.StartDateTime.ToString("MMMM dd, yyyy")</p>
                                    <p class="mb-1"><i class="fas fa-clock text-primary me-2"></i>@ev?.StartDateTime.ToString("h:mm tt") - @ev?.endDateTime.ToString("h:mm tt")</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><i class="fas fa-map-marker-alt text-primary me-2"></i>@ev?.venue</p>
                                    <!-- FIXED: Removed category reference -->
                                    <p class="mb-1"><i class="fas fa-tag text-primary me-2"></i>Event</p>
                                </div>
                            </div>
                        </div>

                        @if (!Model.Any())
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No tickets available for this event.
                            </div>
                        }
                        else
                        {
                            <!-- Ticket Selection Table -->
                            <div class="table-responsive mb-4">
                                <table class="table ticket-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ticket Type</th>
                                            <th>Price</th>
                                            <th>Available</th>
                                            <th style="width: 120px;">Quantity</th>
                                            <th class="text-end">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Count; i++)
                                        {
                                            var ticket = Model[i];
                                            <tr class="ticket-row" data-price="@ticket.Price" data-id="@ticket.TicketTypeId">
                                                <td>
                                                    <strong>@ticket.TypeName</strong>
                                                    @if (ticket.Price == 0)
                                                    {
                                                        <span class="badge bg-success ms-2">FREE</span>
                                                    }
                                                </td>
                                                <td class="ticket-price">
                                                    @if (ticket.Price == 0)
                                                    {
                                                        <span class="text-success">FREE</span>
                                                    }
                                                    else
                                                    {
                                                        @:Rs. @ticket.Price.ToString("N2")
                                                    }
                                                </td>
                                                <td>
                                                    <span class="badge bg-info availability-badge">@ticket.AvailableQuantity</span>
                                                </td>
                                                <td>
                                                    <div class="quantity-control">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary quantity-btn" onclick="decrementQuantity(@ticket.TicketTypeId)">-</button>
                                                        <input type="number"
                                                               name="quantities[@ticket.TicketTypeId]"
                                                               class="form-control form-control-sm ticket-quantity text-center"
                                                               id="qty-@ticket.TicketTypeId"
                                                               min="0"
                                                               max="@ticket.AvailableQuantity"
                                                               value="0"
                                                               data-price="@ticket.Price"
                                                               data-id="@ticket.TicketTypeId"
                                                               readonly>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary quantity-btn" onclick="incrementQuantity(@ticket.TicketTypeId)">+</button>
                                                    </div>
                                                </td>
                                                <td class="text-end subtotal-cell">
                                                    <span class="subtotal" id="subtotal-@ticket.TicketTypeId">Rs. 0.00</span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Promo Code Section -->
                            <div class="promo-section card mb-4">
                                <div class="card-body">
                                    <h6 class="mb-3"><i class="fas fa-tag me-2 text-success"></i>Have a Promo Code?</h6>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="promoCode"
                                                       placeholder="Enter promo code">
                                                <button class="btn btn-success" type="button" id="applyPromo">
                                                    Apply
                                                </button>
                                                <button class="btn btn-outline-danger" type="button" id="removePromo"
                                                        style="display: none;">
                                                    Remove
                                                </button>
                                            </div>
                                            <div id="promoMessage" class="mt-2 small"></div>
                                            <input type="hidden" name="promoCode" id="promoCodeInput" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Available Promos Grid -->
                            @if (availablePromos.Any())
                            {
                                <div class="promos-grid card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-tags me-2 text-success"></i>Available Promotions</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-2">
                                            @foreach (var promo in availablePromos)
                                            {
                                                <div class="col-md-4">
                                                    <div class="promo-card p-2 border rounded" onclick="applyPromoCode('@promo.code')">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold text-success">@promo.code</span>
                                                            @if (promo.DiscountType == "Percentage")
                                                            {
                                                                <span class="badge bg-primary">@promo.DiscountValue% OFF</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-primary">Rs. @promo.DiscountValue.ToString("N2") OFF</span>
                                                            }
                                                        </div>
                                                        <small class="text-muted d-block">Valid until @promo.endDate.ToString("MMM dd, yyyy")</small>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Booking Summary -->
                            <div class="booking-summary card bg-light">
                                <div class="card-body">
                                    <h6 class="mb-3">Booking Summary</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Subtotal:</span>
                                        <span class="fw-bold" id="summarySubtotal">Rs. 0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2 text-success" id="discountRow" style="display: none;">
                                        <span>Discount:</span>
                                        <span class="fw-bold" id="summaryDiscount">- Rs. 0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span class="h5 mb-0">Total:</span>
                                        <span class="h5 mb-0 text-primary fw-bold" id="summaryTotal">Rs. 0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-3 mt-4">
                                <button type="submit" class="btn btn-success btn-lg flex-grow-1" id="submitBtn" disabled>
                                    <i class="fas fa-check-circle me-2"></i>Confirm Booking
                                </button>
                                <a asp-action="Details" asp-route-id="@eventId" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Order Summary</h5>
                </div>
                <div class="card-body">
                    <h6>@ev?.title</h6>
                    <p class="text-muted small">
                        <i class="fas fa-calendar-alt"></i> @ev?.StartDateTime.ToString("MMM dd, yyyy")<br>
                        <i class="fas fa-clock"></i> @ev?.StartDateTime.ToString("h:mm tt")
                    </p>

                    <hr>

                    <div id="orderItems">
                        <p class="text-muted text-center">No tickets selected</p>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-bold" id="sidebarSubtotal">Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-success" id="sidebarDiscount" style="display: none;">
                        <span>Discount:</span>
                        <span id="sidebarDiscountAmount">- Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between fs-5 fw-bold mt-2">
                        <span>Total:</span>
                        <span class="text-primary" id="sidebarTotal">Rs. 0.00</span>
                    </div>

                    <hr>

                    <div class="text-center small text-muted">
                        <i class="fas fa-shield-alt me-1"></i>Secure Checkout
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let promoDiscount = 0;
        let appliedPromoCode = '';

        // Quantity increment/decrement
        function incrementQuantity(id) {
            var input = $('#qty-' + id);
            var max = parseInt(input.attr('max'));
            var current = parseInt(input.val()) || 0;
            if (current < max) {
                input.val(current + 1);
                calculateTotals();
            }
        }

        function decrementQuantity(id) {
            var input = $('#qty-' + id);
            var current = parseInt(input.val()) || 0;
            if (current > 0) {
                input.val(current - 1);
                calculateTotals();
            }
        }

        // Calculate totals
        function calculateTotals() {
            let subtotal = 0;

            $('.ticket-quantity').each(function() {
                let qty = parseInt($(this).val()) || 0;
                let price = parseFloat($(this).data('price'));
                let id = $(this).data('id');
                let lineTotal = qty * price;

                subtotal += lineTotal;
                $(`#subtotal-${id}`).text('Rs. ' + lineTotal.toFixed(2));
            });

            let total = subtotal - promoDiscount;
            if (total < 0) total = 0;

            // Update displays
            $('#summarySubtotal').text('Rs. ' + subtotal.toFixed(2));
            $('#summaryTotal').text('Rs. ' + total.toFixed(2));
            $('#sidebarSubtotal').text('Rs. ' + subtotal.toFixed(2));
            $('#sidebarTotal').text('Rs. ' + total.toFixed(2));

            // Update order items
            let orderHtml = '';
            $('.ticket-quantity').each(function() {
                let qty = parseInt($(this).val()) || 0;
                if (qty > 0) {
                    let type = $(this).closest('tr').find('td:first').text().trim();
                    let price = parseFloat($(this).data('price'));
                    orderHtml += `<div class="d-flex justify-content-between small mb-2">
                        <span>${qty} x ${type}</span>
                        <span>Rs. ${(qty * price).toFixed(2)}</span>
                    </div>`;
                }
            });

            $('#orderItems').html(orderHtml || '<p class="text-muted text-center">No tickets selected</p>');

            // Enable/disable submit button
            $('#submitBtn').prop('disabled', subtotal === 0);
        }

        // Apply promo code
        $('#applyPromo').click(function() {
            let code = $('#promoCode').val().trim();
            if (!code) {
                $('#promoMessage').html('<span class="text-danger">Please enter a promo code</span>');
                return;
            }

            let subtotal = parseFloat($('#summarySubtotal').text().replace('Rs. ', ''));

            $.ajax({
                url: '@Url.Action("Validate", "BOOKING_PROMO")',
                type: 'POST',
                data: {
                    code: code,
                    eventId: @eventId,
                    totalAmount: subtotal
                },
                success: function(response) {
                    if (response.valid) {
                        appliedPromoCode = code;
                        promoDiscount = response.discountAmount;

                        $('#promoCodeInput').val(code);
                        $('#promoMessage').html('<span class="text-success">' + response.message + '</span>');
                        $('#applyPromo').hide();
                        $('#removePromo').show();
                        $('#discountRow').show();
                        $('#sidebarDiscount').show();
                        $('#summaryDiscount').text('- Rs. ' + promoDiscount.toFixed(2));
                        $('#sidebarDiscountAmount').text('- Rs. ' + promoDiscount.toFixed(2));

                        calculateTotals();
                    } else {
                        $('#promoMessage').html('<span class="text-danger">' + response.message + '</span>');
                    }
                },
                error: function() {
                    $('#promoMessage').html('<span class="text-danger">Error validating promo code</span>');
                }
            });
        });

        // Remove promo code
        $('#removePromo').click(function() {
            appliedPromoCode = '';
            promoDiscount = 0;
            $('#promoCode').val('');
            $('#promoCodeInput').val('');
            $('#promoMessage').html('');
            $('#applyPromo').show();
            $('#removePromo').hide();
            $('#discountRow').hide();
            $('#sidebarDiscount').hide();
            calculateTotals();
        });

        // Apply promo from grid
        function applyPromoCode(code) {
            $('#promoCode').val(code);
            $('#applyPromo').click();
        }

        // Auto-calculate on quantity change
        $('.ticket-quantity').on('change input', calculateTotals);

        // Form validation
        $('#bookingForm').submit(function(e) {
            let hasTickets = $('.ticket-quantity').toArray().some(input => parseInt($(input).val()) > 0);
            if (!hasTickets) {
                e.preventDefault();
                alert('Please select at least one ticket');
            }
        });

        // Initial calculation
        calculateTotals();
    </script>
}

<style>
    .booking-card {
        border: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .quantity-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ticket-quantity {
        width: 50px;
        text-align: center;
        -moz-appearance: textfield;
    }

        .ticket-quantity::-webkit-outer-spin-button,
        .ticket-quantity::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

    .promo-card {
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

        .promo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #28a745 !important;
        }

    .ticket-table th {
        font-weight: 600;
        color: #495057;
    }

    .subtotal-cell {
        font-weight: 600;
        color: #4361ee;
    }
</style>