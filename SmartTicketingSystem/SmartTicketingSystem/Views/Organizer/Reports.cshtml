@{
    ViewData["Title"] = "Reports";
    var ev = ViewBag.Event as SmartTicketingSystem.Models.EVENT;
    var dailySales = ViewBag.DailySales as List<dynamic> ?? new List<dynamic>();
    var ticketBreakdown = ViewBag.TicketBreakdown as List<dynamic> ?? new List<dynamic>();
    var promoEffectiveness = ViewBag.PromoEffectiveness as List<dynamic> ?? new List<dynamic>();

    // Helper function to format currency
    string FormatCurrency(decimal amount)
    {
        return "Rs. " + amount.ToString("N2");
    }
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-chart-bar"></i> Reports for @ev?.title</h2>
        </div>
        <div>
            <a asp-action="Dashboard" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6>Total Revenue</h6>
                    <h3>Rs. @dailySales.Sum(d => (decimal)d.Revenue).ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6>Total Bookings</h6>
                    <h3>@dailySales.Sum(d => (int)d.Count)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6>Total Tickets Sold</h6>
                    <h3>@ticketBreakdown.Sum(t => (int)t.Sold)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6>Promo Discounts</h6>
                    <h3>Rs. @promoEffectiveness.Sum(p => (decimal)p.TotalDiscount).ToString("N2")</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Daily Sales Chart -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Daily Sales (Last 30 Days)</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Ticket Breakdown Chart -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Tickets Sold by Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="ticketBreakdownChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Breakdown Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Ticket Sales Breakdown</h5>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ticket Type</th>
                        <th>Tickets Sold</th>
                        <th>Revenue</th>
                        <th>% of Total</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var totalRevenue = ticketBreakdown.Sum(t => (decimal)t.Revenue);
                    }
                    @foreach (var item in ticketBreakdown)
                    {
                        var percentage = totalRevenue > 0 ? ((decimal)item.Revenue / totalRevenue * 100) : 0;
                        <tr>
                            <td>@item.TicketType</td>
                            <td>@item.Sold</td>
                            <td>Rs. @item.Revenue.ToString("N2")</td>
                            <td>@percentage.ToString("F1")%</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Promo Effectiveness Table -->
    @if (promoEffectiveness.Any())
    {
        <div class="card">
            <div class="card-header">
                <h5>Promo Code Effectiveness</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Promo Code</th>
                            <th>Times Used</th>
                            <th>Total Discount</th>
                            <th>Average Discount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in promoEffectiveness)
                        {
                            var avgDiscount = item.TimesUsed > 0 ? (decimal)item.TotalDiscount / (int)item.TimesUsed : 0;
                            <tr>
                                <td>@item.PromoCode</td>
                                <td>@item.TimesUsed</td>
                                <td>Rs. @item.TotalDiscount.ToString("N2")</td>
                                <td>Rs. @avgDiscount.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Daily Sales Chart
        new Chart(document.getElementById('dailySalesChart'), {
            type: 'line',
            data: {
                labels: [@Html.Raw(string.Join(",", dailySales.Select(d => $"'{d.Date.ToString("MMM dd")}'")))],
                datasets: [{
                    label: 'Revenue (Rs.)',
                    data: [@string.Join(",", dailySales.Select(d => d.Revenue))],
                    borderColor: 'green',
                    tension: 0.1,
                    yAxisID: 'y'
                }, {
                    label: 'Bookings',
                    data: [@string.Join(",", dailySales.Select(d => d.Count))],
                    borderColor: 'blue',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Revenue (Rs.)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Number of Bookings'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                }
            }
        });

        // Ticket Breakdown Chart
        new Chart(document.getElementById('ticketBreakdownChart'), {
            type: 'pie',
            data: {
                labels: [@Html.Raw(string.Join(",", ticketBreakdown.Select(t => $"'{t.TicketType}'")))],
                datasets: [{
                    data: [@string.Join(",", ticketBreakdown.Select(t => t.Sold))],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                    ]
                }]
            }
        });
    </script>
}