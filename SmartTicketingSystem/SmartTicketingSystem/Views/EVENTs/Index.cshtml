@model IEnumerable<SmartTicketingSystem.Models.EVENT>
@if (User.IsInRole("Admin"))
{
    // show admin crud buttons
}


@{
    ViewData["Title"] = "Events";
    bool isAdmin = User.IsInRole("Admin");
    bool isOrganizer = User.IsInRole("Organizer");
    bool isUniMember = User.IsInRole("UniversityMember");
    bool isExtMember = User.IsInRole("ExternalMember");
}

<div class="container py-4">

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <h2 class="mb-0">Upcoming Events</h2>
            <div class="text-muted">
                @if (!User.Identity.IsAuthenticated)
                {
                    <span>Showing public events.</span>
                }
                else if (isUniMember)
                {
                    <span>Showing public + university events (including pending upcoming).</span>
                }
                else
                {
                    <span>Showing public events.</span>
                }
            </div>
        </div>

        @if (isAdmin || isOrganizer)
        {
            <a asp-action="Create" class="btn btn-primary">
                + Create Event
            </a>
        }
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-warning">
            No upcoming events found.
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var e in Model)
            {
                // status badge style
                string statusClass =
                e.status == "Published" ? "bg-success"
                : e.status == "PendingUpcoming" ? "bg-warning text-dark"
                : e.status == "PendingApproval" ? "bg-secondary"
                : e.status == "Draft" ? "bg-dark"
                : "bg-secondary";

                // visibility badge style
                string visClass =
                e.visibility == "Public" ? "bg-primary"
                : "bg-info text-dark"; // University

                <div class="col-12">
                    <div class="card shadow-sm rounded-4">
                        <div class="card-body p-4">

                            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
                                <div class="me-2" style="min-width:260px;">
                                    <div class="d-flex flex-wrap gap-2 mb-2">
                                        <span class="badge @visClass">@e.visibility</span>
                                        <span class="badge @statusClass">@e.status</span>

                                        @if (e.IsOnline == 'Y')
                                        {
                                            <span class="badge bg-light text-dark border">Online</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-dark border">Onsite</span>
                                        }
                                    </div>

                                    <h4 class="mb-1">@e.title</h4>

                                    <div class="text-muted">
                                        @e.StartDateTime.ToString("yyyy-MM-dd HH:mm")
                                        @if (e.endDateTime != default(DateTime))
                                        {
                                            <span> - @e.endDateTime.ToString("yyyy-MM-dd HH:mm")</span>
                                        }
                                    </div>

                                    <div class="mt-2">
                                        <span class="fw-semibold">Venue:</span>
                                        <span class="text-muted">@e.venue</span>
                                    </div>
                                </div>

                                <div class="flex-grow-1">
                                    @if (!string.IsNullOrWhiteSpace(e.Description))
                                    {
                                        <p class="mb-2 text-muted" style="max-width:900px;">
                                            @(e.Description.Length > 220 ? e.Description.Substring(0, 220) + "..." : e.Description)
                                        </p>
                                    }

                                    <div class="d-flex flex-wrap gap-3 small text-muted">
                                        <div><span class="fw-semibold">Capacity:</span> @e.capacity</div>

                                        @if (!string.IsNullOrWhiteSpace(e.AccessibilityInfo))
                                        {
                                            <div><span class="fw-semibold">Accessibility:</span> Yes</div>
                                        }
                                        else
                                        {
                                            <div><span class="fw-semibold">Accessibility:</span> Not specified</div>
                                        }

                                        @if (e.IsOnline == 'Y' && !string.IsNullOrWhiteSpace(e.onlineLink))
                                        {
                                            <div>
                                                <a href="@e.onlineLink" target="_blank" class="text-decoration-none">Online Link</a>
                                            </div>
                                        }

                                        @if (e.IsOnline == 'N' && !string.IsNullOrWhiteSpace(e.maplink))
                                        {
                                            <div>
                                                <a href="@e.maplink" target="_blank" class="text-decoration-none">Map</a>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="text-end" style="min-width:220px;">
                                    <div class="d-grid gap-2">
                                        <a asp-action="Details" asp-route-id="@e.eventID" class="btn btn-outline-secondary">
                                            View Details
                                        </a>

                                        @* Organizer/Admin actions *@
                                        @if (isAdmin || isOrganizer)
                                        {
                                            <a asp-action="Edit" asp-route-id="@e.eventID" class="btn btn-outline-dark">
                                                Edit
                                            </a>
                                        }

                                        @* Submit for approval only when Draft and Organizer/Admin *@
                                        @if ((isAdmin || isOrganizer) && e.status == "Draft")
                                        {
                                            <form asp-action="SubmitForApproval" method="post" class="m-0">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@e.eventID" />
                                                <button type="submit" class="btn btn-primary w-100">
                                                    Submit For Approval
                                                </button>
                                            </form>
                                        }
                                    </div>

                                    @* Note for members about pending status *@
                                    @if (e.status == "PendingUpcoming" && isUniMember)
                                    {
                                        <div class="mt-2 small text-muted">
                                            This event is pending approval (University).
                                        </div>
                                    }
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
